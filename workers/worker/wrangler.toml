name = "epir-art-jewellery-worker"
main = "src/index.ts"
compatibility_date = "2025-09-30"
compatibility_flags = ["nodejs_compat"]
workers_dev = false

[build]
command = ""

[durable_objects]
bindings = [
  { name = "SESSION_DO", class_name = "SessionDO" },
  { name = "RATE_LIMITER_DO", class_name = "RateLimiterDO" },
  { name = "TOKEN_VAULT_DO", class_name = "TokenVaultDO" }
]

[[d1_databases]]
binding = "DB"
database_name = "jewelry-analytics-db"
database_id = "6a4f7cbb-3c1c-42c7-9d79-4ef74d421f23"

[[kv_namespaces]]
binding = "SESSIONS_KV"
id = "08f16276a9b14ca7b3c00404e8e8d0d9"


# Queues require paid plan - commented out for now
# [[queues.producers]]
# binding = "INDEX_QUEUE"
# queue = "epir-index-queue"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["SessionDO"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["RateLimiterDO"]

[[migrations]]
tag = "v3"
new_sqlite_classes = ["TokenVaultDO"]

# AI binding
[ai]
binding = "AI"

# Service binding to AI worker (reusable Groq client)
[[services]]
binding = "AI_WORKER"
service = "epir-ai-worker"

# Service binding to RAG worker (reusable RAG orchestrator)
[[services]]
binding = "RAG_WORKER"
service = "epir-rag-worker"

# Routes - subdomena dla Workera
[[routes]]
pattern = "asystent.epirbizuteria.pl/*"
zone_name = "epirbizuteria.pl"

[observability]
enabled = true
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
# Log filter: Only logs from THIS worker (epir-art-jewellery-worker)
# Cloudflare automatically prefixes logs with worker name in dashboard
# Use filter in dashboard: ScriptName == "epir-art-jewellery-worker"

[vars]
ALLOWED_ORIGIN = "https://epir-art-silver-jewellery.myshopify.com"
SHOP_DOMAIN = "epir-art-silver-jewellery.myshopify.com"
# WORKER_ORIGIN: URL Workera dla internal MCP calls (używane w rag.ts callMcpTool)
# W produkcji: https://asystent.epirbizuteria.pl
# W dev: https://asystent-epir.YOUR-NAME.workers.dev
WORKER_ORIGIN = "https://asystent.epirbizuteria.pl"

